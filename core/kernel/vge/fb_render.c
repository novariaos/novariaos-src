// SPDX-License-Identifier: GPL-3.0-only

#include <log.h>
#include <core/kernel/kstd.h>
#include <core/kernel/vge/fb_render.h>
#include <core/kernel/vge/palette.h>
#include <limine.h>
#include <stdint.h>
#include <stddef.h>
#include <stdbool.h>
#include <string.h>

#define FONT_HEIGHT 16

extern int system_font_height;
extern uint8_t system_font[256][FONT_HEIGHT];

volatile struct limine_framebuffer_request fb_request = {
    .id = LIMINE_FRAMEBUFFER_REQUEST_ID,
    .revision = 0,
    .response = NULL
};

static struct {
    struct limine_framebuffer *fb;
    uint32_t *fb_addr;
    uint64_t width;
    uint64_t height;
    uint64_t pitch;
    uint64_t pitch_pixels;
    uint32_t bg_color;
    uint32_t fg_color;
    uint32_t cursor_x;
    uint32_t cursor_y;
    uint32_t char_width;
    uint32_t char_height;
    bool initialized;
    size_t scroll_pixels;
    size_t remaining_pixels;
    uint32_t *clear_area_start;
    size_t scroll_bytes;       // precomputed: char_height * pitch
    size_t screen_bytes;       // precomputed: height * pitch
    size_t clear_words;        // precomputed: scroll_bytes / sizeof(uint32_t)
    size_t remaining_bytes;    // precomputed: (height - char_height) * pitch
    uint32_t *clear_area;      // precomputed: fb_addr + (remaining_bytes / 4)
} fb_info = {0};

// Built-in fallback font (used when system_font is not loaded)
const uint8_t builtin_font[128][8] = {
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+0000 (nul)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+0001
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+0002
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+0003
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+0004
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+0005
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+0006
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+0007
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+0008
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+0009
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+000A
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+000B
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+000C
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+000D
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+000E
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+000F
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+0010
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+0011
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+0012
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+0013
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+0014
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+0015
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+0016
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+0017
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+0018
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+0019
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+001A
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+001B
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+001C
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+001D
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+001E
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+001F
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+0020 (space)
    {0x18, 0x3C, 0x3C, 0x18, 0x18, 0x00, 0x18, 0x00}, // U+0021 (!)
    {0x6C, 0x6C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+0022 (")
    {0x6C, 0x6C, 0xFE, 0x6C, 0xFE, 0x6C, 0x6C, 0x00}, // U+0023 (#)
    {0x30, 0x7C, 0xC0, 0x78, 0x0C, 0xF8, 0x30, 0x00}, // U+0024 ($)
    {0x00, 0xC6, 0xCC, 0x18, 0x30, 0x66, 0xC6, 0x00}, // U+0025 (%)
    {0x38, 0x6C, 0x38, 0x76, 0xDC, 0xCC, 0x76, 0x00}, // U+0026 (&)
    {0x60, 0x60, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+0027 (')
    {0x18, 0x30, 0x60, 0x60, 0x60, 0x30, 0x18, 0x00}, // U+0028 (()
    {0x60, 0x30, 0x18, 0x18, 0x18, 0x30, 0x60, 0x00}, // U+0029 ())
    {0x00, 0x66, 0x3C, 0xFF, 0x3C, 0x66, 0x00, 0x00}, // U+002A (*)
    {0x00, 0x30, 0x30, 0xFC, 0x30, 0x30, 0x00, 0x00}, // U+002B (+)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x30, 0x60}, // U+002C (,)
    {0x00, 0x00, 0x00, 0xFC, 0x00, 0x00, 0x00, 0x00}, // U+002D (-)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x30, 0x00}, // U+002E (.)
    {0x06, 0x0C, 0x18, 0x30, 0x60, 0xC0, 0x80, 0x00}, // U+002F (/)
    {0x7C, 0xC6, 0xCE, 0xDE, 0xF6, 0xE6, 0x7C, 0x00}, // U+0030 (0)
    {0x30, 0x70, 0x30, 0x30, 0x30, 0x30, 0xFC, 0x00}, // U+0031 (1)
    {0x78, 0xCC, 0x0C, 0x38, 0x60, 0xCC, 0xFC, 0x00}, // U+0032 (2)
    {0x78, 0xCC, 0x0C, 0x38, 0x0C, 0xCC, 0x78, 0x00}, // U+0033 (3)
    {0x1C, 0x3C, 0x6C, 0xCC, 0xFE, 0x0C, 0x1E, 0x00}, // U+0034 (4)
    {0xFC, 0xC0, 0xF8, 0x0C, 0x0C, 0xCC, 0x78, 0x00}, // U+0035 (5)
    {0x38, 0x60, 0xC0, 0xF8, 0xCC, 0xCC, 0x78, 0x00}, // U+0036 (6)
    {0xFC, 0xCC, 0x0C, 0x18, 0x30, 0x30, 0x30, 0x00}, // U+0037 (7)
    {0x78, 0xCC, 0xCC, 0x78, 0xCC, 0xCC, 0x78, 0x00}, // U+0038 (8)
    {0x78, 0xCC, 0xCC, 0x7C, 0x0C, 0x18, 0x70, 0x00}, // U+0039 (9)
    {0x00, 0x30, 0x30, 0x00, 0x00, 0x30, 0x30, 0x00}, // U+003A (:)
    {0x00, 0x30, 0x30, 0x00, 0x00, 0x30, 0x30, 0x60}, // U+003B (;)
    {0x18, 0x30, 0x60, 0xC0, 0x60, 0x30, 0x18, 0x00}, // U+003C (<)
    {0x00, 0x00, 0xFC, 0x00, 0x00, 0xFC, 0x00, 0x00}, // U+003D (=)
    {0x60, 0x30, 0x18, 0x0C, 0x18, 0x30, 0x60, 0x00}, // U+003E (>)
    {0x78, 0xCC, 0x0C, 0x18, 0x30, 0x00, 0x30, 0x00}, // U+003F (?)
    {0x7C, 0xC6, 0xDE, 0xDE, 0xDE, 0xC0, 0x78, 0x00}, // U+0040 (@)
    {0x30, 0x78, 0xCC, 0xCC, 0xFC, 0xCC, 0xCC, 0x00}, // U+0041 (A)
    {0xFC, 0x66, 0x66, 0x7C, 0x66, 0x66, 0xFC, 0x00}, // U+0042 (B)
    {0x3C, 0x66, 0xC0, 0xC0, 0xC0, 0x66, 0x3C, 0x00}, // U+0043 (C)
    {0xF8, 0x6C, 0x66, 0x66, 0x66, 0x6C, 0xF8, 0x00}, // U+0044 (D)
    {0xFE, 0x62, 0x68, 0x78, 0x68, 0x62, 0xFE, 0x00}, // U+0045 (E)
    {0xFE, 0x62, 0x68, 0x78, 0x68, 0x60, 0xF0, 0x00}, // U+0046 (F)
    {0x3C, 0x66, 0xC0, 0xC0, 0xCE, 0x66, 0x3E, 0x00}, // U+0047 (G)
    {0xCC, 0xCC, 0xCC, 0xFC, 0xCC, 0xCC, 0xCC, 0x00}, // U+0048 (H)
    {0x78, 0x30, 0x30, 0x30, 0x30, 0x30, 0x78, 0x00}, // U+0049 (I)
    {0x1E, 0x0C, 0x0C, 0x0C, 0xCC, 0xCC, 0x78, 0x00}, // U+004A (J)
    {0xE6, 0x66, 0x6C, 0x78, 0x6C, 0x66, 0xE6, 0x00}, // U+004B (K)
    {0xF0, 0x60, 0x60, 0x60, 0x62, 0x66, 0xFE, 0x00}, // U+004C (L)
    {0xC6, 0xEE, 0xFE, 0xFE, 0xD6, 0xC6, 0xC6, 0x00}, // U+004D (M)
    {0xC6, 0xE6, 0xF6, 0xDE, 0xCE, 0xC6, 0xC6, 0x00}, // U+004E (N)
    {0x38, 0x6C, 0xC6, 0xC6, 0xC6, 0x6C, 0x38, 0x00}, // U+004F (O)
    {0xFC, 0x66, 0x66, 0x7C, 0x60, 0x60, 0xF0, 0x00}, // U+0050 (P)
    {0x78, 0xCC, 0xCC, 0xCC, 0xDC, 0x78, 0x1C, 0x00}, // U+0051 (Q)
    {0xFC, 0x66, 0x66, 0x7C, 0x6C, 0x66, 0xE6, 0x00}, // U+0052 (R)
    {0x78, 0xCC, 0xE0, 0x70, 0x1C, 0xCC, 0x78, 0x00}, // U+0053 (S)
    {0xFC, 0xB4, 0x30, 0x30, 0x30, 0x30, 0x78, 0x00}, // U+0054 (T)
    {0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0xFC, 0x00}, // U+0055 (U)
    {0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0x78, 0x30, 0x00}, // U+0056 (V)
    {0xC6, 0xC6, 0xC6, 0xD6, 0xFE, 0xEE, 0xC6, 0x00}, // U+0057 (W)
    {0xC6, 0xC6, 0x6C, 0x38, 0x38, 0x6C, 0xC6, 0x00}, // U+0058 (X)
    {0xCC, 0xCC, 0xCC, 0x78, 0x30, 0x30, 0x78, 0x00}, // U+0059 (Y)
    {0xFE, 0xC6, 0x8C, 0x18, 0x32, 0x66, 0xFE, 0x00}, // U+005A (Z)
    {0x78, 0x60, 0x60, 0x60, 0x60, 0x60, 0x78, 0x00}, // U+005B ([)
    {0xC0, 0x60, 0x30, 0x18, 0x0C, 0x06, 0x02, 0x00}, // U+005C (\)
    {0x78, 0x18, 0x18, 0x18, 0x18, 0x18, 0x78, 0x00}, // U+005D (])
    {0x10, 0x38, 0x6C, 0xC6, 0x00, 0x00, 0x00, 0x00}, // U+005E (^)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF}, // U+005F (_)
    {0x30, 0x30, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+0060 (`)
    {0x00, 0x00, 0x78, 0x0C, 0x7C, 0xCC, 0x76, 0x00}, // U+0061 (a)
    {0xE0, 0x60, 0x60, 0x7C, 0x66, 0x66, 0xDC, 0x00}, // U+0062 (b)
    {0x00, 0x00, 0x78, 0xCC, 0xC0, 0xCC, 0x78, 0x00}, // U+0063 (c)
    {0x1C, 0x0C, 0x0C, 0x7C, 0xCC, 0xCC, 0x76, 0x00}, // U+0064 (d)
    {0x00, 0x00, 0x78, 0xCC, 0xFC, 0xC0, 0x78, 0x00}, // U+0065 (e)
    {0x38, 0x6C, 0x60, 0xF0, 0x60, 0x60, 0xF0, 0x00}, // U+0066 (f)
    {0x00, 0x00, 0x76, 0xCC, 0xCC, 0x7C, 0x0C, 0xF8}, // U+0067 (g)
    {0xE0, 0x60, 0x6C, 0x76, 0x66, 0x66, 0xE6, 0x00}, // U+0068 (h)
    {0x30, 0x00, 0x70, 0x30, 0x30, 0x30, 0x78, 0x00}, // U+0069 (i)
    {0x0C, 0x00, 0x0C, 0x0C, 0x0C, 0xCC, 0xCC, 0x78}, // U+006A (j)
    {0xE0, 0x60, 0x66, 0x6C, 0x78, 0x6C, 0xE6, 0x00}, // U+006B (k)
    {0x70, 0x30, 0x30, 0x30, 0x30, 0x30, 0x78, 0x00}, // U+006C (l)
    {0x00, 0x00, 0xCC, 0xFE, 0xFE, 0xD6, 0xC6, 0x00}, // U+006D (m)
    {0x00, 0x00, 0xF8, 0xCC, 0xCC, 0xCC, 0xCC, 0x00}, // U+006E (n)
    {0x00, 0x00, 0x78, 0xCC, 0xCC, 0xCC, 0x78, 0x00}, // U+006F (o)
    {0x00, 0x00, 0xDC, 0x66, 0x66, 0x7C, 0x60, 0xF0}, // U+0070 (p)
    {0x00, 0x00, 0x76, 0xCC, 0xCC, 0x7C, 0x0C, 0x1E}, // U+0071 (q)
    {0x00, 0x00, 0xDC, 0x76, 0x66, 0x60, 0xF0, 0x00}, // U+0072 (r)
    {0x00, 0x00, 0x7C, 0xC0, 0x78, 0x0C, 0xF8, 0x00}, // U+0073 (s)
    {0x10, 0x30, 0x7C, 0x30, 0x30, 0x34, 0x18, 0x00}, // U+0074 (t)
    {0x00, 0x00, 0xCC, 0xCC, 0xCC, 0xCC, 0x76, 0x00}, // U+0075 (u)
    {0x00, 0x00, 0xCC, 0xCC, 0xCC, 0x78, 0x30, 0x00}, // U+0076 (v)
    {0x00, 0x00, 0xC6, 0xD6, 0xFE, 0xFE, 0x6C, 0x00}, // U+0077 (w)
    {0x00, 0x00, 0xC6, 0x6C, 0x38, 0x6C, 0xC6, 0x00}, // U+0078 (x)
    {0x00, 0x00, 0xCC, 0xCC, 0xCC, 0x7C, 0x0C, 0xF8}, // U+0079 (y)
    {0x00, 0x00, 0xFC, 0x98, 0x30, 0x64, 0xFC, 0x00}, // U+007A (z)
    {0x1C, 0x30, 0x30, 0xE0, 0x30, 0x30, 0x1C, 0x00}, // U+007B ({)
    {0x18, 0x18, 0x18, 0x00, 0x18, 0x18, 0x18, 0x00}, // U+007C (|)
    {0xE0, 0x30, 0x30, 0x1C, 0x30, 0x30, 0xE0, 0x00}, // U+007D (})
    {0x76, 0xDC, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // U+007E (~)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}  // U+007F
};

void init_fb(void) {
    if (fb_request.response == NULL ||
        fb_request.response->framebuffer_count == 0) {
        return;
    }

    fb_info.fb = fb_request.response->framebuffers[0];
    fb_info.fb_addr = (uint32_t*)fb_info.fb->address;
    fb_info.width = fb_info.fb->width;
    fb_info.height = fb_info.fb->height;
    fb_info.pitch = fb_info.fb->pitch;
    fb_info.pitch_pixels = fb_info.pitch / 4;

    fb_info.char_width = 8;
    fb_info.char_height = 16;

    fb_info.bg_color = 0x0a0a0a;
    fb_info.fg_color = 0xe6e6e6;

    fb_info.cursor_x = 0;
    fb_info.cursor_y = 0;

    fb_info.scroll_bytes = fb_info.char_height * fb_info.pitch;
    fb_info.screen_bytes = fb_info.height * fb_info.pitch;
    fb_info.remaining_bytes = fb_info.screen_bytes - fb_info.scroll_bytes;
    fb_info.scroll_pixels = fb_info.char_height * fb_info.pitch_pixels;
    fb_info.clear_area_start = fb_info.fb_addr +
                               (fb_info.remaining_bytes / sizeof(uint32_t));
    fb_info.clear_words = fb_info.scroll_bytes / sizeof(uint32_t);

    fb_info.initialized = true;

    clear_screen();
}

uint32_t* get_framebuffer(void) {
    return fb_info.fb_addr;
}

void get_fb_dimensions(uint32_t* width, uint32_t* height, uint32_t* pitch) {
    if (width) *width = fb_info.width;
    if (height) *height = fb_info.height;
    if (pitch) *pitch = fb_info.pitch;
}

uint32_t get_fb_pitch_pixels(void) {
    return fb_info.pitch_pixels;
}

static void put_pixel(uint32_t x, uint32_t y, uint32_t color) {
    if (!fb_info.initialized) return;
    if (x >= fb_info.width || y >= fb_info.height) return;

    uint32_t *pixel = &fb_info.fb_addr[y * fb_info.pitch_pixels + x];
    *pixel = color;
}

static void draw_char(uint32_t x, uint32_t y, char c, uint32_t color) {
    if (!fb_info.initialized) return;
    if (c < 0 || c >= 128) return;

    const uint8_t *glyph = system_font[(int)c];

    int height_to_draw = system_font_height;
    if (height_to_draw > FONT_HEIGHT) {
        height_to_draw = FONT_HEIGHT;
    }

    for (int row = 0; row < height_to_draw; row++) {
        uint8_t row_data = glyph[row];
        for (uint32_t col = 0; col < 8; col++) {
            if (row_data & (1 << (7 - col))) {
                put_pixel(x + col, y + row, color);
            }
        }
    }
}

void clear_screen(void) {
    if (!fb_info.initialized) return;

    for (uint32_t y = 0; y < fb_info.height; y++) {
        for (uint32_t x = 0; x < fb_info.width; x++) {
            put_pixel(x, y, fb_info.bg_color);
        }
    }

    fb_info.cursor_x = 0;
    fb_info.cursor_y = 0;
}

void newline(void) {
    if (!fb_info.initialized) return;

    fb_info.cursor_x = 0;
    fb_info.cursor_y += fb_info.char_height;

    // Если курсор ушел за пределы экрана
    if (fb_info.cursor_y + fb_info.char_height > fb_info.height) {
        
        // 1. Сдвигаем экран вверх ровно на высоту символа за ОДИН вызов memmove
        uint8_t *src = (uint8_t*)fb_info.fb_addr + fb_info.scroll_bytes;
        uint8_t *dst = (uint8_t*)fb_info.fb_addr;
        
        memmove(dst, src, fb_info.remaining_bytes);

        // 2. Очищаем только что освободившуюся нижнюю строку (куда будем печатать)
        uint32_t *bottom_area = (uint32_t*)((uint8_t*)fb_info.fb_addr + fb_info.remaining_bytes);
        
        for (size_t i = 0; i < fb_info.clear_words; i++) {
            bottom_area[i] = fb_info.bg_color;
        }
        
        // 3. Возвращаем курсор на нижнюю строку
        fb_info.cursor_y = fb_info.height - fb_info.char_height;
    }
}

void fb_putchar(char c, int color) {
    if (!fb_info.initialized) return;

    if (c == '\n') {
        newline();
        return;
    }

    if (c == '\t') {
        fb_info.cursor_x += fb_info.char_width * 4;
        return;
    }

    if (fb_info.cursor_x + fb_info.char_width > fb_info.width) {
        newline();
    }

    uint32_t y_offset = (fb_info.char_height - system_font_height) / 2;

    draw_char(fb_info.cursor_x, fb_info.cursor_y + y_offset, c, color);

    fb_info.cursor_x += fb_info.char_width;
}

void vgaprint(const char *str, int color) {
    if (!fb_info.initialized) return;

    uint32_t fb_color = palette_get_color(color);

    while (*str) {
        fb_putchar(*str, fb_color);
        str++;
    }
}

void set_bg_color(uint32_t color) {
    if (!fb_info.initialized) return;
    fb_info.bg_color = color;
}

void set_fg_color(uint32_t color) {
    if (!fb_info.initialized) return;
    fb_info.fg_color = color;
}

void vga_backspace(void) {
    if (!fb_info.initialized) return;

    if (fb_info.cursor_x == 0) {
        return;
    }

    fb_info.cursor_x -= fb_info.char_width;

    uint32_t y_offset = (fb_info.char_height - system_font_height) / 2;

    draw_rect(fb_info.cursor_x, fb_info.cursor_y + y_offset,
              fb_info.char_width, system_font_height, fb_info.bg_color);
}

void set_cursor_pos(uint32_t x, uint32_t y) {
    if (!fb_info.initialized) return;

    fb_info.cursor_x = x * fb_info.char_width;
    fb_info.cursor_y = y * fb_info.char_height;

    if (fb_info.cursor_x >= fb_info.width) fb_info.cursor_x = 0;
    if (fb_info.cursor_y >= fb_info.height) fb_info.cursor_y = 0;
}

uint32_t get_screen_width_chars(void) {
    if (!fb_info.initialized) return 0;
    return fb_info.width / fb_info.char_width;
}

uint32_t get_screen_height_chars(void) {
    if (!fb_info.initialized) return 0;
    return fb_info.height / fb_info.char_height;
}

void draw_rect(uint32_t x, uint32_t y, uint32_t width, uint32_t height, uint32_t color) {
    if (!fb_info.initialized) return;   

    for (uint32_t dy = 0; dy < height; dy++) {
        for (uint32_t dx = 0; dx < width; dx++) {
            put_pixel(x + dx, y + dy, color);
        }
    }
}

void draw_line(uint32_t x1, uint32_t y1, uint32_t x2, uint32_t y2, uint32_t color) {
    if (!fb_info.initialized) return;

    int dx = (x2 > x1) ? (x2 - x1) : (x1 - x2);
    int dy = (y2 > y1) ? (y2 - y1) : (y1 - y2);
    int sx = (x1 < x2) ? 1 : -1;
    int sy = (y1 < y2) ? 1 : -1;
    int err = dx - dy;

    while (1) {
        put_pixel(x1, y1, color);
        if (x1 == x2 && y1 == y2) break;

        int e2 = 2 * err;
        if (e2 > -dy) {
            err -= dy;
            x1 += sx;
        }
        if (e2 < dx) {
            err += dx;
            y1 += sy;
        }
    }
}

void get_cursor_pos(uint32_t *x, uint32_t *y) {
    if (!fb_info.initialized) {
        if (x) *x = 0;
        if (y) *y = 0;
        return;
    }
    
    if (x) *x = fb_info.cursor_x / fb_info.char_width;
    if (y) *y = fb_info.cursor_y / fb_info.char_height;
}
